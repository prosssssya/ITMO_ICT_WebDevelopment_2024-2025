# API средствами Django REST Framework
serializers.py

    class DriverSerializer(serializers.ModelSerializer):
        routes = serializers.PrimaryKeyRelatedField(
            queryset=Route.objects.all(),
            many=True
        )
    
        class Meta:
            model = Driver
            fields = '__all__'
    
    
    class RouteSerializer(serializers.ModelSerializer):
        class Meta:
            model = Route
            fields = '__all__'
    
    
    class BusSerializer(serializers.ModelSerializer):
        class Meta:
            model = Bus
            fields = '__all__'
    
    
    class DriverScheduleSerializer(serializers.ModelSerializer):
        class Meta:
            model = DriverSchedule
            fields = "__all__"
    
    
    class BusAssignmentSerializer(serializers.ModelSerializer):
    
        class Meta:
            model = BusAssignment
            fields = '__all__'
    
    
    class MaintenanceSerializer(serializers.ModelSerializer):
    
        class Meta:
            model = Maintenance
            fields = '__all__'

views.py

    class DriverCreateAPIView(generics.CreateAPIView):
        serializer_class = DriverSerializer
        queryset = Driver.objects.all()
        permission_classes = [IsAuthenticated]
    
    
    class DriverListAPIView(generics.ListAPIView):
        serializer_class = DriverSerializer
        queryset = Driver.objects.prefetch_related('routes').all()
    
    
    class DriverDetailAPIView(generics.RetrieveAPIView):
        serializer_class = DriverSerializer
        queryset = Driver.objects.prefetch_related('routes').all()
    
    
    class RouteCreateAPIView(generics.CreateAPIView):
        serializer_class = RouteSerializer
        queryset = Route.objects.all()
    
    
    class RouteListAPIView(generics.ListAPIView):
        serializer_class = RouteSerializer
        queryset = Route.objects.all()
    
    
    class RouteDetailAPIView(generics.RetrieveAPIView):
        serializer_class = RouteSerializer
        queryset = Route.objects.all()
    
    
    class BusCreateAPIView(generics.CreateAPIView):
        serializer_class = BusSerializer
        queryset = Bus.objects.all()
    
    
    class BusListAPIView(generics.ListAPIView):
        serializer_class = BusSerializer
        queryset = Bus.objects.all()
    
    
    class BusDetailAPIView(generics.RetrieveAPIView):
        serializer_class = BusSerializer
        queryset = Bus.objects.all()
    
    
    class DriverScheduleListAPIView(generics.ListAPIView):
        serializer_class = DriverScheduleSerializer
        queryset = DriverSchedule.objects.select_related('driver', 'bus', 'route').all()
    
    
    class BusAssignmentListAPIView(generics.ListAPIView):
        serializer_class = BusAssignmentSerializer
        queryset = BusAssignment.objects.select_related('bus', 'route').all()
    
    
    class MaintenanceListAPIView(generics.ListAPIView):
        serializer_class = MaintenanceSerializer
        queryset = Maintenance.objects.select_related('bus').all()
    
    
    class DriverScheduleCreateAPIView(generics.CreateAPIView):
        serializer_class = DriverScheduleSerializer
        queryset = DriverSchedule.objects.select_related('driver', 'bus', 'route').all()
    
    
    class BusAssignmentCreateAPIView(generics.CreateAPIView):
        serializer_class = BusAssignmentSerializer
        queryset = BusAssignment.objects.select_related('bus', 'route').all()
    
    
    class MaintenanceCreateAPIView(generics.CreateAPIView):
        serializer_class = MaintenanceSerializer
        queryset = Maintenance.objects.select_related('bus').all()
    
    
    class RouteDeleteAPIView(generics.DestroyAPIView):
        serializer_class = RouteSerializer
        queryset = Route.objects.all()
    
    
    class DriverScheduleUpdateAPIView(generics.RetrieveUpdateAPIView):
        serializer_class = DriverScheduleSerializer
        queryset = DriverSchedule.objects.select_related('driver', 'bus', 'route').all()
    
    
    class MaintenanceUpdateAPIView(generics.RetrieveUpdateAPIView):
        serializer_class = MaintenanceSerializer
        queryset = Maintenance.objects.select_related('bus').all()
    
    
    class BusAssignmentUpdateAPIView(generics.RetrieveUpdateAPIView):
        serializer_class = BusAssignmentSerializer
        queryset = BusAssignment.objects.select_related('bus', 'route').all()
    
    
    class DriverUpdateAPIView(generics.RetrieveUpdateAPIView):
        serializer_class = DriverSerializer
        queryset = Driver.objects.prefetch_related('routes').all()
    
    
    class RouteUpdateAPIView(generics.RetrieveUpdateAPIView):
        serializer_class = RouteSerializer
        queryset = Route.objects.all()
    
    
    class RouteSerializer(serializers.ModelSerializer):
        class Meta:
            model = Route
            fields = ['route_num', 'start_point', 'end_point', 'start_time', 'end_time']
    
    
    class DriverSerializer(serializers.ModelSerializer):
        class Meta:
            model = Driver
            fields = ['name', 'surname']
    
    
    class DriverScheduleSerializer(serializers.ModelSerializer):
        driver = DriverSerializer() 
    
        class Meta:
            model = DriverSchedule
            fields = ['id', 'work_date', 'shift_start', 'shift_end', 'driver', 'bus', 'route']
    
    
    class DriversForRouteAPIView(generics.ListAPIView):
        "Список водителей, работающих на определенном маршруте с указанием графика их работы"
    
        serializer_class = DriverScheduleSerializer
    
        def get_queryset(self):
            route_num = self.request.query_params.get('route_num')
            return DriverSchedule.objects.filter(route__route_num=route_num).select_related('driver', 'route')
    
    
    class RouteScheduleAPIView(generics.ListAPIView):
        "Когда начинается и заканчивается движение автобусов на каждом маршруте?"
        serializer_class = RouteSerializer
        queryset = Route.objects.all()
    
    
    class MissingBusesAPIView(APIView):
        def get(self, request):
            date = self.request.query_params.get('date')
            if not date:
                return Response({"error": "Пожалуйста, укажите дату."}, status=status.HTTP_400_BAD_REQUEST)
    
            scheduled_buses = DriverSchedule.objects.filter(work_date=date).values_list('bus_id', flat=True)
    
            unscheduled_buses = Bus.objects.exclude(id__in=scheduled_buses).prefetch_related('maintenance_set')
    
            data = []
            for bus in unscheduled_buses:
                reason = None
                if bus.status == Bus.BusStatus.IN_REPAIR:
                    maintenance = bus.maintenance_set.filter(maintenance_date=date).first()
                    reason = maintenance.reason if maintenance else "Не указана"
                else:
                    reason = "Нет водителя"
                data.append({"bus": bus.registration_num, "reason": reason})
    
            return Response(data)
    
    
    class DriverCountByClassAPIView(APIView):
        "Сколько водителей каждого класса работает в автопарке?"
        def get(self, request):
            driver_counts = Driver.objects.values('driver_class').annotate(count=models.Count('id'))
            return Response({"driver_counts": driver_counts})
    
    
    class TotalRouteDurationAPIView(APIView):
        "Какова общая протяженность маршрутов, обслуживаемых автопарком?"
    
        def get(self, request, *args, **kwargs):
            total_duration = Route.objects.aggregate(total=Sum('duration'))['total'] or 0
            return Response({"total_duration": total_duration})
bus_app\urls.py

    urlpatterns = [
        path('drivers/', DriverListAPIView.as_view(), name='driver-list'),
        path('drivers/create/', DriverCreateAPIView.as_view(), name='driver-create'),
        path('drivers/<int:pk>/', DriverDetailAPIView.as_view(), name='driver-detail'),
        path('routes/', RouteListAPIView.as_view(), name='route-list'),
        path('routes/create/', RouteCreateAPIView.as_view(), name='route-create'),
        path('routes/<int:pk>/', RouteDetailAPIView.as_view(), name='route-detail'),
        path('buses/', BusListAPIView.as_view(), name='bus-list'),
        path('buses/create/', BusCreateAPIView.as_view(), name='bus-create'),
        path('buses/<int:pk>/', BusDetailAPIView.as_view(), name='bus-detail'),
        path('driver-schedules/', DriverScheduleListAPIView.as_view(), name='driver-schedule-list'),
        path('bus-assignments/', BusAssignmentListAPIView.as_view(), name='bus-assignment-list'),
        path('maintenances/', MaintenanceListAPIView.as_view(), name='maintenance-list'),
        path("bus-assignments/create/", BusAssignmentCreateAPIView.as_view(), name="bus-assignment-create"),
        path("maintenance/create/", MaintenanceCreateAPIView.as_view(), name="maintenance-create"),
        path("driver-schedule/create/", DriverScheduleCreateAPIView.as_view(), name="driver-schedule-create"),
        path("routes/<int:pk>/delete/", RouteDeleteAPIView.as_view(), name="route-delete"),
        path("driver-schedules/<int:pk>/update/", DriverScheduleUpdateAPIView.as_view(), name="driver-schedule-update"),
        path("maintenance/<int:pk>/update/", MaintenanceUpdateAPIView.as_view(), name="maintenance-update"),
        path("bus-assignments/<int:pk>/update/", BusAssignmentUpdateAPIView.as_view(), name="bus-assignment-update"),
        path("drivers/<int:pk>/update/", DriverUpdateAPIView.as_view(), name="driver-update"),
        path("routes/<int:pk>/update/", RouteUpdateAPIView.as_view(), name="route-update"),
        path('drivers-for-route/', DriversForRouteAPIView.as_view(), name='drivers-for-route'),
        path('route-schedule/', RouteScheduleAPIView.as_view(), name='route-schedule'),
        path('missing-buses/', MissingBusesAPIView.as_view(), name='missing-buses'),
        path('driver-count-by-class/', DriverCountByClassAPIView.as_view(), name='driver-count-by-class'),
        path('total-duration/', TotalRouteDurationAPIView.as_view(), name='total-duration'),
    ]
